# Abundance

Here is a review of existing methods.

## Lincoln-Peterson

## Full Likelihood

## Conditional Likelihood

The conditional likelihood abundance estimator proposed by @huggins_statistical_1989 and @alho_logistic_1990, which was further extended in @huggins_practical_1991, is an extension to previous abundance estimators to account for heterogeneous capture probabilities ($p$). The model estimates individual capture probabilities and abundance conditional on captured individuals.


### Algebra
The capture history $y_{i,t}$ is used to estimate the capture probability of individual $i$ as a Bernoulli trial,
$$y_{i,t} \sim Bernoulli(p_{i,t}) $$
$$\mathcal{L}(p| y) = \prod_{i=1}^n \prod_{t=1}^t p_{i,t}^{z_{i,t}}(1-p_{i,t})^{1-z_{i,t}}$$

Abundance $\hat{N}$ is derived conditional on the count of known individuals ($C$), sometimes referred to the minimum number of known alive ($MNKA$).
$$\hat{N} = \frac{C}{1-\prod^{t}(1-p_t)}$$
Variation in detection probability can be modeled using linear logistic models or other variations used to estimate probabilities 0-1.

### Simulation 

```{r}
set.seed(1)
N <- 150 #True population size
n_occ <- 4 #Number of trapping occasions
p <- 0.50 #Probability of first detection

true_detections <- array(NA, dim=c(N,n_occ))
for (t in 1:n_occ){
  true_detections[,t] <- rbinom(n=N,size=1,prob=p)
}
observed <- true_detections[apply(true_detections,1,max) == 1,]
MNKA <- nrow(observed)
print( paste0("Number ever detected: ", MNKA,sep = " ") ) #number ever detected
```
### Models {.tabset}

::: {.tab}
<button class="tablinks" onclick="unrolltab(event,'JAGS')">JAGS</button>
<button class="tablinks" onclick="unrolltab(event,'NIMBLE')">NIMBLE</button>
<button class="tablinks" onclick="unrolltab(event, 'Stan')">Stan</button>
<button class="tablinks" onclick="unrolltab(event, 'Greta')">Greta</button>
::: {#JAGS .tabcontent}
#### JAGS model fit {-}
```{r ,eval = FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide'}
library(R2jags)
data <- list(
  y=observed,
  n_sites=nrow(observed),
  MNKA=MNKA,
  n_occ=n_occ
)
model_string <- textConnection(
  "
  model {
  # Likelihood
  for(i in 1:n_sites) {
    # Observation model
    for(j in 1:n_occ) {
      y[i, j] ~ dbern(p)
    }
  }
  for(t in 1:n_occ){
    p_un[t] <- (1-p)
  }
  # Priors
  p ~ dunif(0, 1) # Uninformative prior
  # Derived values
  N <- (MNKA / (1-prod(p_un[])))
}")
parameters <- c("p","N")
inits <- function() {
  list( 
  )
}
ni <- 10000 ; nt <- 1 ; nb <- 5000 ; nc <- 3
model <- jags(data, inits, parameters, model_string, n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb)
```
:::
::: {#NIMBLE .tabcontent}
#### NIMBLE model fit {-}
```{r ,eval = FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide'}
library(nimble)
n_data <- list(
  y = observed,
  MNKA = MNKA
)
n_constants <- list(
  n_occ = n_occ
)
Nimble_Code <- nimbleCode({
  # Likelihood
  for(i in 1:MNKA) {
    # Observation model
    for(j in 1:n_occ) {
      y[i, j] ~ dbern(p)
    } #j
  } #i
  
  # Priors
  p ~ dunif(0, 1) # Uninformative prior
  
  # Derived values
  for(t in 1:n_occ){
    p_un[t] <- (1-p)
  } #t
  N <- (MNKA / (1-prod(p_un[1:n_occ]))) #The only difference in this model is here declaring dimensions
})

n_params <- c("p", "N")
n_inits <- list( 
  
)
Nimble_Model <- nimbleModel(
  code = Nimble_Code,
  constants = n_constants,
  data = n_data,
  inits = n_inits
)
MCMC_Model <- configureMCMC(Nimble_Model, monitors = n_params, print = T, enableWAIC = F)
Model1_MCMC <- buildMCMC(MCMC_Model)
Comp_Model <- compileNimble( Nimble_Model, showCompilerOutput = TRUE )
Comp_Model <- compileNimble(Model1_MCMC, project = Nimble_Model)

niter=10000
Model_samples <- runMCMC(Comp_Model, niter = niter, nburnin=niter/2,nchains=3,summary = TRUE)
#mcmc_combo(Model_samples$samples, pars = c("N", "p"))
round(Model_samples$summary$all.chains,2)
```
:::
::: {#Stan .tabcontent}
#### Stan model fit {-}
```{r ,eval = FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide'}
library(knitr)
library(rstan)
data <- list(
  y=observed,
  nsites=nrow(observed),
  MNKA=MNKA,
  n_occ=n_occ
)
stan_model <- "
data {
  int<lower=0> MNKA;
  int<lower=0> nsites;
  int<lower=0> n_occ;
  int<lower=0,upper=1> y[MNKA, n_occ];
}
parameters {
  real<lower=0, upper=1> p;
}
model {  
 for(i in 1:nsites)
    for(j in 1:4)
      target += bernoulli_lpmf(y[i, j] | p);
}
generated quantities {
  real pstar = (1-(1-p)^n_occ);
  real N = MNKA / pstar;
}
"
nc <- 4
stan.samples <- stan(model_code = stan_model, data = data, iter = 10000, chains = nc, cores = nc, open_progress=FALSE)
```
:::
::: {#Greta .tabcontent}
#### Greta model fit{-}
```{r ,eval = FALSE,warning=FALSE,message=FALSE,error=FALSE, results='hide'}
library(reticulate)
reticulate::use_condaenv("r-reticulate")
reticulate::py_config()
library(greta)
capture_vec <- unlist(observed)
# priors
p_greta <- beta(1, 1)
# likelihood
distribution(capture_vec) <- bernoulli(p_greta)
# derived parameters
pstar <- 1 - (1 - p_greta)^n_occ
N_hat <- MNKA / pstar
# defining the model
m <- model(p_greta, N_hat, pstar)
# sampling
draws <- greta::mcmc(m, n_samples = 1000)
```
```{r,eval = FALSE}
plot(m)
```
:::
:::

### Comparison
```{r, echo=FALSE,warning=FALSE}
# round(model$BUGSoutput$summary[c(1,3),c(1,2,3,7)],2) #jags
# round(summary(stan.samples)$summary[c(2,1),c(1,3,4,8)],2) #stan
# summary(draws) #greta
library(gt)
library(tidyverse)
results_df <- data.frame(
              Sampler=c("Simulated","JAGS","NIMBLE","Stan","greta","Simulated","JAGS","NIMBLE","Stan","greta"),
              Parameter=c("N","N","N","N","N","p","p","p","p","p"),
              Mean=c(150,149.73,149.73,149.73,149.73,NA,0.52,0.52,0.52,0.52),
              SD=c(NA,1.46,1.46,1.43,1.44,NA,0.02,0.02,0.02,0.02),
              LCL=c(NA,147.21,147.21,147.25,147.22,NA,0.48,0.48,0.48,0.48),
              UCL=c(NA,152.95,152.95,152.79,152.96,NA,0.57,0.57,0.57,0.57)
              )

# Create a gt table based on preprocessed
# `sp500` table data
results_df %>%
  dplyr::select(-Sampler,-Parameter) %>%
  gt() %>%
  tab_row_group(
    group = "p",
    rows = 5:8
  ) %>%
  tab_row_group(
    group = "N",
    rows = 1:4
  ) %>%
  tab_header(
    title = "Estimate Comparison",
    subtitle = "Comparison of Huggins abundance (N) and detection 
              \n probability (p) estimates fit using JAGS, Stan, greta."
  )
```


## Data Augmentation
## N-Mixture Model
## Distance Sampling
## Spatial Capture-Recapture
## Time to Event
    
